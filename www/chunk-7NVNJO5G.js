import{A as S,T as U,x as b}from"./chunk-J7TXCJLH.js";import{a as h,b as w,g as M}from"./chunk-OLRFWS6T.js";var g=function(a){return a[a.Up=1]="Up",a[a.Down=3]="Down",a[a.Right=6]="Right",a[a.Left=8]="Left",a[a.UpMirrored=2]="UpMirrored",a[a.DownMirrored=4]="DownMirrored",a[a.LeftMirrored=5]="LeftMirrored",a[a.RightMirrored=7]="RightMirrored",a[a.Default=0]="Default",a[a.NotJpeg=-1]="NotJpeg",a[a.NotDefined=-2]="NotDefined",a}(g||{}),C=class{constructor(){this.byteCount=t=>encodeURI(t).split(/%..|./).length-1}getOrientation(t){return new Promise((s,i)=>{try{let n=new FileReader;n.onload=()=>{let r=new DataView(n.result);if(!r.byteLength||r.getUint16(0,!1)!==65496)return s(g.NotDefined);let c=r.byteLength,e=2;for(;e<c;){let l=r.getUint16(e,!1);if(e+=2,l===65505){if(r.getUint32(e+=2,!1)!==1165519206)return s(g.NotJpeg);let m=r.getUint16(e+=6,!1)===18761;e+=r.getUint32(e+4,m);let u=r.getUint16(e,m);e+=2;for(let o=0;o<u;o++)if(r.getUint16(e+o*12,m)===274)return s(r.getUint16(e+o*12+8,m))}else{if((l&65280)!==65280)break;e+=r.getUint16(e,!1)}}return s(g.NotJpeg)},n.readAsArrayBuffer(t)}catch{return i(g.Default)}})}uploadFile(t,s=!0,i=!1){return new Promise((n,r)=>{let c=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),e=/iPad|iPhone|iPod/i.test(navigator.userAgent);Promise.resolve(c||e).then(l=>l?this.generateUploadInputNative(window.document,s,i):this.generateUploadInputRenderer(t,s,i)).then(l=>{let m=l?Array.from(l):[],u=m.map(f=>this.getOrientation(f)),o=m.map(f=>this.fileToDataURL(f)),d=[];Promise.all(u).then(f=>(d=f,Promise.all(o))).then(f=>{let p=f.map((v,x)=>({image:v.dataUrl,orientation:d[x],fileName:v.fileName}));n(s?p:p[0])})}).catch(l=>r(l))})}fileToDataURL(t){return new Promise((s,i)=>{let n=new FileReader;n.onload=r=>{s({dataUrl:r.target.result,fileName:t.name})};try{n.readAsDataURL(t)}catch(r){i(`ngx-image-compress - probably no file have been selected: ${r}`)}})}generateUploadInputRenderer(t,s=!0,i=!1){let n=!1;return new Promise((r,c)=>{let e=t.createElement("input");t.setStyle(e,"display","none"),t.setProperty(e,"type","file"),t.setProperty(e,"accept","image/*, .heic"),s&&t.setProperty(e,"multiple","true"),t.listen(e,"click",l=>{l.target.value=""}),t.listen(e,"change",l=>{n=!0;let m=l.target.files;r(m)}),i&&window.addEventListener("focus",()=>{setTimeout(()=>{n||c(new Error("file upload on blur - no file selected"))},300)},{once:!0}),e.click()})}generateUploadInputNative(t,s=!0,i=!1){let n=!1;return new Promise((r,c)=>{let e=t.createElement("input");e.id="upload-input"+new Date,e.style.display="none",e.setAttribute("type","file"),e.setAttribute("accept","image/*, .heic"),s&&e.setAttribute("multiple","true"),t.body.appendChild(e),e.addEventListener("change",()=>{n=!0,r(e.files),t.body.removeChild(t.getElementById(e.id))},{once:!0}),i&&window.addEventListener("focus",()=>{setTimeout(()=>{!n&&t.getElementById(e.id)&&(c(new Error("file upload on blur - no file selected")),t.body.removeChild(t.getElementById(e.id)))},300)},{once:!0}),e.click()})}compress(t,s,i,n=50,r=50,c=0,e=0){return new Promise(function(l,m){r=r/100,n=n/100;let u=new Image;u.onload=()=>{let o=i.createElement("canvas"),d=o.getContext("2d");if(!d)return m("No canvas context available");let f=u.naturalWidth,p=u.naturalHeight;if(!CSS.supports("image-orientation","from-image")&&(s===g.Right||s===g.Left)){let k=f;f=p,p=k}let v=c?c/f:1,x=e?e/p:1;n=Math.min(n,v,x),o.width=f*n,o.height=p*n;let y=Math.PI/180;CSS.supports("image-orientation","from-image")||s===g.Up?d.drawImage(u,0,0,o.width,o.height):s===g.Right?(d.save(),d.rotate(90*y),d.translate(0,-o.width),d.drawImage(u,0,0,o.height,o.width),d.restore()):s===g.Left?(d.save(),d.rotate(-90*y),d.translate(-o.width,0),d.drawImage(u,0,0,o.height,o.width),d.restore()):s===g.Down?(d.save(),d.rotate(180*y),d.translate(-o.width,-o.height),d.drawImage(u,0,0,o.width,o.height),d.restore()):d.drawImage(u,0,0,o.width,o.height);let P=t.substr(5,t.split(";")[0].length-5),B=o.toDataURL(P,r);l(B)},u.onerror=o=>m(o),u.src=t})}uploadGetImageMaxSize(t,s,i,n=!1){return M(this,null,function*(){s&&console.debug("Ngxthis - Opening upload window");let r=yield this.uploadFile(i,!1,n);return yield this.getImageMaxSize(r,t,s,i)})}getImageMaxSize(t,s,i,n){return M(this,null,function*(){let c=l=>(l/1024/1024).toFixed(2);i&&console.debug("Ngxthis - Opening upload window");let e;for(let l=0;l<10;l++){let m=this.byteCount(t.image);e=yield this.compress(t.image,t.orientation,n,50,100);let u=this.byteCount(e);if(console.debug("Ngxthis -","Compression from",c(m),"MB to",c(u),"MB"),u>=m)throw l===0?(i&&console.debug("Ngxthis -","File can't be reduced at all - returning the original",c(m),"MB large"),w(h({},t),{image:e})):(i&&console.debug("Ngxthis -","File can't be reduced more - returning the best we can, which is ",c(m),"MB large"),w(h({},t),{image:e}));if(u<s*1024*1024)return i&&console.debug("Ngxthis -","Here your file",c(u),"MB large"),w(h({},t),{image:e});if(l===9)throw i&&console.debug("Ngxthis -","File can't reach the desired size after",10,"tries. Returning file ",c(m),"MB large"),w(h({},t),{image:e});i&&console.debug("Ngxthis -","Reached",c(u),"MB large. Trying another time after",l+1,"times"),t.image=e}throw i&&console.debug("Ngxthis - Unexpected error"),{}})}},Z=(()=>{let t=class t{constructor(i){this.DOC_ORIENTATION=g,this.render=i.createRenderer(null,null),this.imageCompress=new C}byteCount(i){return this.imageCompress.byteCount(i)}getOrientation(i){return this.imageCompress.getOrientation(i)}uploadFile(){return this.imageCompress.uploadFile(this.render,!1)}uploadMultipleFiles(){return this.imageCompress.uploadFile(this.render,!0)}uploadFileOrReject(){return this.imageCompress.uploadFile(this.render,!1,!0)}uploadMultipleFilesOrReject(){return this.imageCompress.uploadFile(this.render,!0,!0)}compressFile(i,n,r=50,c=50,e=0,l=0){return this.imageCompress.compress(i,n,this.render,r,c,e,l)}uploadAndGetImageWithMaxSize(i=1,n=!1,r=!1){return this.imageCompress.uploadGetImageMaxSize(i,n,this.render,r).then(c=>c.image).catch(c=>{throw c.image})}uploadAndGetImageWithMaxSizeAndMetas(i=1,n=!1,r=!1){return this.imageCompress.uploadGetImageMaxSize(i,n,this.render,r)}getImageWithMaxSizeAndMetas(i,n=1,r=!1){return this.imageCompress.getImageMaxSize(i,n,r,this.render)}};t.\u0275fac=function(n){return new(n||t)(S(U))},t.\u0275prov=b({token:t,factory:t.\u0275fac,providedIn:"root"});let a=t;return a})();export{Z as a};
