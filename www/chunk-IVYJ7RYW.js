import{a as L,b as T,c as F,d as j,e as z,f as k,h as H,i as D,j as Q,k as c,l as G,m as f,n as A,p as J,q as g,s as K,t as q,u as R}from"./chunk-O5PN56JD.js";import{B as M,Za as O,k as h,l as y,n as C,s as _,t as v,x as B}from"./chunk-J7TXCJLH.js";import{a as $,b as x,g as b}from"./chunk-OLRFWS6T.js";var ie=(()=>{let w=class w{constructor(){this.firestore=M(k),this.http=M(O),this.cloudinaryCloudName="do64wlw72",this.cloudinaryUploadPreset="PitadaDeSabor",this.cloudinaryUploadUrl=`https://api.cloudinary.com/v1_1/${this.cloudinaryCloudName}/image/upload`,this.recipesCollection=D(this.firestore,"recipes"),this.categoriesCollection=D(this.firestore,"categories"),this.difficultiesCollection=D(this.firestore,"difficulties"),this.timesCollection=D(this.firestore,"times"),this.usersCollection=D(this.firestore,"users"),this.unitsCollection=D(this.firestore,"units"),this.foodTypesCollection=D(this.firestore,"foodTypes"),this.foodTypeIdToLabelMap=new Map,this.loadFoodTypesMap()}loadFoodTypesMap(){return b(this,null,function*(){try{(yield A(this.foodTypesCollection)).forEach(i=>{this.foodTypeIdToLabelMap.set(i.id,i.data().label)}),console.log("[ReceitaService] Mapeamento de foodTypes carregado:",this.foodTypeIdToLabelMap)}catch(e){console.error("Erro ao carregar mapeamento de foodTypes:",e)}})}uploadRecipeImage(e){let i=new FormData;return i.append("file",e),i.append("upload_preset",this.cloudinaryUploadPreset),this.http.post(this.cloudinaryUploadUrl,i).pipe(C(r=>r.secure_url),_(r=>{throw console.error("Erro no upload de imagem para o Cloudinary:",r),r}))}getAllCategories(){return h(A(this.categoriesCollection)).pipe(C(e=>{let i=[];return e.forEach(r=>{i.push({id:r.id,label:r.data().label})}),i}),_(e=>(console.error("Erro ao buscar todas as categorias:",e),y([]))))}getRecipesByCreator(e){let i=c(this.firestore,"users",e),r=g(this.recipesCollection,R("user_id","==",i));return h(A(r)).pipe(v(o=>b(this,null,function*(){let n=[],l=[];for(let t of o.docs){let s=t.data(),p="Desconhecido";s.user_id instanceof T?l.push(f(s.user_id).then(a=>{if(a.exists()){let u=a.data();return u.user_name||u.displayName||u.email||"Desconhecido"}return"Desconhecido"}).catch(a=>(console.error(`Erro ao buscar nome de usu\xE1rio para ID ${s.user_id.id}:`,a),"Desconhecido"))):l.push(f(c(this.firestore,"users",s.user_id)).then(a=>{if(a.exists()){let u=a.data();return u.user_name||u.displayName||u.email||"Desconhecido"}return"Desconhecido"}).catch(a=>(console.error(`Erro ao buscar nome de usu\xE1rio para ID ${s.user_id}:`,a),"Desconhecido"))),n.push({id:t.id,recipeName:s.recipe_name||"Sem Nome",photoUrl:s.photo_url||s.photo||"assets/placeholder.png",description:s.description||"",categoryId:s.category_id?s.category_id.id:null,difficultyId:s.difficulty_id?s.difficulty_id.id:null,timeId:s.time_id?s.time_id.id:null,userId:s.user_id?s.user_id instanceof T?s.user_id.id:s.user_id:null,categoryLabel:s.category_label||"N\xE3o definida",difficultyLabel:s.difficulty_label||"N\xE3o definida",timeLabel:s.time_label||"N\xE3o definido",userName:"",ingredientFoodTypes:Array.isArray(s.ingredient_food_type)?s.ingredient_food_type:[],createdAt:s.createdAt instanceof L?s.createdAt.toDate().toISOString():null,readTime:this.calculateReadTimeFromTimeId(s.time_id)})}return(yield Promise.all(l)).forEach((t,s)=>{n[s].userName=t}),console.log(`[getRecipesByCreator] Retornando ${n.length} receitas para o criador ${e}.`),n})),_(o=>(console.error("Erro ao buscar receitas por criador:",o),y([]))))}calculateReadTimeFromTimeId(e){if(!e)return 5;switch(e){case"1":return 10;case"2":return 25;case"3":return 45;case"4":return 75;default:return 5}}buscarReceitaPorIdComDetalhes(e){let i=c(this.recipesCollection,e);return h(f(i)).pipe(v(r=>b(this,null,function*(){if(!r.exists()){console.log(`[getRecipeById] Receita com ID ${e} n\xE3o encontrada.`);return}let o=r.data(),n=[];Array.isArray(o.ingredients)&&o.ingredients.length>0&&(n=yield Promise.all(o.ingredients.map(t=>b(this,null,function*(){var a,u;let s="N/A";if(t.unit_id){let m=yield f(t.unit_id);m.exists()&&(s=((a=m.data())==null?void 0:a.label)||"N/A")}let p="N/A";if(t.food_type_id){let m=yield f(t.food_type_id);m.exists()&&(p=((u=m.data())==null?void 0:u.label)||"N/A")}return{fdcId:t.fdc_id||null,name:t.ingredient_name,quantity:t.quantity,unitId:t.unit_id?t.unit_id.id:null,unitLabel:s,foodTypeId:t.food_type_id?t.food_type_id.id:null,foodTypeLabel:p}}))));let l="Desconhecido";if(o.user_id)try{let t=o.user_id instanceof T?o.user_id:c(this.firestore,"users",o.user_id),s=yield f(t);if(s.exists()){let p=s.data();l=p.user_name||p.displayName||p.email||"Desconhecido",console.log(`[getRecipeById] Nome de usu\xE1rio obtido para receita ${e}:`,l)}}catch(t){console.error(`Erro ao buscar nome de usu\xE1rio para ID ${o.user_id}:`,t)}let I={id:r.id,recipe:{recipeName:o.recipe_name||"Sem Nome",description:o.description||"",photoUrl:o.photo_url||o.photo||"assets/placeholder.png",preparationSteps:Array.isArray(o.preparation_mode)?o.preparation_mode:[],ingredients:n,categoryId:o.category_id?o.category_id.id:null,categoryLabel:o.category_label||"N\xE3o definida",difficultyId:o.difficulty_id?o.difficulty_id.id:null,difficultyLabel:o.difficulty_label||"N\xE3o definida",timeId:o.time_id?o.time_id.id:null,timeLabel:o.time_label||"N\xE3o definido",userId:o.user_id?o.user_id instanceof T?o.user_id.id:o.user_id:null,userName:l,createdAt:o.createdAt instanceof L?o.createdAt.toDate().toISOString():null,updatedAt:o.updatedAt instanceof L?o.updatedAt.toDate().toISOString():null,ingredientFoodTypes:Array.isArray(o.ingredient_food_type)?o.ingredient_food_type:[]}};return console.log(`[getRecipeById] Receita ${e} encontrada e formatada.`),I})),_(r=>(console.error("Erro ao buscar receita por ID do Firestore:",r),y(void 0))))}getRecipes(e){let i=g(this.recipesCollection);if(e!=null&&e.foodTypes&&e.foodTypes.length>0){let r=[];e.foodTypes.forEach(o=>{let n=this.foodTypeIdToLabelMap.get(o);n&&r.push(n)}),console.log("[ReceitaService] Filtrando por r\xF3tulos de foodTypes:",r),r.length>0&&(r.length<=10?i=g(i,R("ingredient_food_type","array-contains-any",r)):(console.warn("Limite de 10 valores para array-contains-any excedido. Filtrando apenas os primeiros 10."),i=g(i,R("ingredient_food_type","array-contains-any",r.slice(0,10)))))}if(e!=null&&e.categories&&e.categories.length>0)if(e.categories.length===1)i=g(i,R("category_id","==",c(this.firestore,"categories",e.categories[0])));else{let r=e.categories.map(o=>c(this.firestore,"categories",o));r.length<=10?i=g(i,R("category_id","in",r)):(console.warn('Limite de 10 valores para filtro "in" excedido. Filtrando apenas os primeiros 10.'),i=g(i,R("category_id","in",r.slice(0,10))))}if(e!=null&&e.time&&e.time.length>0&&(i=g(i,R("time_id","==",c(this.firestore,"times",e.time[0])))),e!=null&&e.difficulty&&e.difficulty.length>0&&(i=g(i,R("difficulty_id","==",c(this.firestore,"difficulties",e.difficulty[0])))),e!=null&&e.recipeName){let r=e.recipeName.toLowerCase();i=g(i,J("recipe_name_lower"),K(r),G(r+"\uF8FF"))}return h(A(i)).pipe(v(r=>b(this,null,function*(){let o=[],n=[];for(let I of r.docs){let t=I.data(),s="Desconhecido";if(t.user_id)try{let p=t.user_id instanceof T?t.user_id:c(this.firestore,"users",t.user_id);n.push(f(p).then(a=>{if(a.exists()){let u=a.data();return u.user_name||u.displayName||u.email||"Desconhecido"}return"Desconhecido"}).catch(a=>(console.error(`Erro ao buscar nome de usu\xE1rio para ID ${t.user_id}:`,a),"Desconhecido")))}catch(p){console.error(`Erro inesperado ao processar user_id ${t.user_id}:`,p),n.push(Promise.resolve("Desconhecido"))}else n.push(Promise.resolve("Desconhecido"));o.push({id:I.id,recipeName:t.recipe_name||"Sem Nome",photoUrl:t.photo_url||t.photo||"assets/placeholder.png",description:t.description||"",categoryId:t.category_id?t.category_id.id:null,difficultyId:t.difficulty_id?t.difficulty_id.id:null,timeId:t.time_id?t.time_id.id:null,userId:t.user_id?t.user_id instanceof T?t.user_id.id:t.user_id:null,categoryLabel:t.category_label||"N\xE3o definida",difficultyLabel:t.difficulty_label||"N\xE3o definida",timeLabel:t.time_label||"N\xE3o definido",userName:"",ingredientFoodTypes:Array.isArray(t.ingredient_food_type)?t.ingredient_food_type:[],createdAt:t.createdAt instanceof L?t.createdAt.toDate().toISOString():null,readTime:this.calculateReadTimeFromTimeId(t.time_id)})}return(yield Promise.all(n)).forEach((I,t)=>{o[t].userName=I}),o})),_(r=>(console.error("Erro ao listar receitas do Firestore:",r),y([]))))}saveRecipe(e){return h(this.resolveRecipeReferences(e)).pipe(v(i=>b(this,null,function*(){let r=x($({},i),{createdAt:F(),updatedAt:F(),recipe_name_lower:i.recipe_name.toLowerCase()}),o=yield H(this.recipesCollection,r);return console.log(`[createRecipe] Receita criada com sucesso. ID: ${o.id}`),{message:"Receita criada com sucesso!",recipeId:o.id}})),_(i=>{throw console.error("Erro ao criar receita no Firestore:",i),i}))}updateRecipe(e,i){let r=c(this.recipesCollection,e);return h(this.resolveRecipeReferences(i)).pipe(v(o=>b(this,null,function*(){let n=x($({},o),{updatedAt:F(),recipe_name_lower:o.recipe_name.toLowerCase()});return yield q(r,n),console.log(`[updateRecipe] Receita ${e} atualizada com sucesso.`),{message:"Receita atualizada com sucesso!"}})),_(o=>{throw console.error("Erro ao atualizar receita no Firestore:",o),o}))}deleteRecipe(e){let i=c(this.recipesCollection,e);return h(Q(i)).pipe(C(()=>(console.log(`[deleteRecipe] Receita ${e} deletada com sucesso.`),{message:"Receita deletada com sucesso!"})),_(r=>{throw console.error("Erro ao deletar receita no Firestore:",r),r}))}resolveRecipeReferences(e){return b(this,null,function*(){let[i,r,o,n,l]=yield Promise.all([e.categoryId?f(c(this.firestore,"categories",e.categoryId)):Promise.resolve(null),e.difficultyId?f(c(this.firestore,"difficulties",e.difficultyId)):Promise.resolve(null),e.timeId?f(c(this.firestore,"times",e.timeId)):Promise.resolve(null),A(this.unitsCollection),A(this.foodTypesCollection)]),I=new Map;n.forEach(a=>I.set(a.id,a.data().label));let t=new Map;l.forEach(a=>t.set(a.id,a.data().label));let s=yield Promise.all(e.ingredients.map(a=>b(this,null,function*(){var d,U;let u="N/A";if(a.unitId){let N=yield f(c(this.firestore,"units",a.unitId));N.exists()&&(u=((d=N.data())==null?void 0:d.label)||"N/A")}let m="N/A";if(a.foodTypeId){let N=yield f(c(this.foodTypesCollection,a.foodTypeId));N.exists()&&(m=((U=N.data())==null?void 0:U.label)||"N/A")}return{fdc_id:a.fdcId||null,ingredient_name:a.name,quantity:a.quantity,unit_id:a.unitId?c(this.firestore,"units",a.unitId):null,unit_label:u,food_type_id:a.foodTypeId?c(this.foodTypesCollection,a.foodTypeId):null,food_type_label:m}}))),p=[...new Set(s.map(a=>a.food_type_label).filter(Boolean))];return{recipe_name:e.recipeName,description:e.description,photo_url:e.photoUrl,user_id:e.userId?c(this.usersCollection,e.userId):null,category_id:e.categoryId?c(this.categoriesCollection,e.categoryId):null,category_label:i&&i.exists()?i.data().label:"N\xE3o definida",difficulty_id:e.difficultyId?c(this.difficultiesCollection,e.difficultyId):null,difficulty_label:r&&r.exists()?r.data().label:"N\xE3o definida",time_id:e.timeId?c(this.timesCollection,e.timeId):null,time_label:o&&o.exists()?o.data().label:"N\xE3o definido",preparation_mode:e.preparationSteps,ingredients:s,ingredient_food_type:p}})}isRecipeFavorite(e,i){if(!e||!i)return y(!1);let r=c(this.usersCollection,e);return h(f(r)).pipe(C(o=>{var n;return o.exists()&&((n=o.data().favoriteRecipeIds)==null?void 0:n.includes(i))||!1}),_(o=>(console.error("Erro ao verificar status de favorito:",o),y(!1))))}toggleFavoriteRecipe(e,i,r){if(!e||!i)return console.error("UserId ou RecipeId inv\xE1lidos para alternar favoritos."),y(void 0);let o=c(this.usersCollection,e),n=r?{favoriteRecipeIds:z(i)}:{favoriteRecipeIds:j(i)};return h(q(o,n)).pipe(C(()=>{console.log(`Receita ${i} ${r?"removida de":"adicionada a"} favoritos do usu\xE1rio ${e}.`)}),_(l=>{throw console.error("Erro ao alternar favorito:",l),l}))}getFavoriteRecipes(e){if(!e)return console.log("UserId n\xE3o fornecido para buscar favoritos."),y([]);let i=c(this.usersCollection,e);return h(f(i)).pipe(v(r=>{if(r.exists()){let n=r.data().favoriteRecipeIds||[];if(n.length===0)return y([]);let l=n.filter(s=>s&&s.trim()!=="");if(l.length===0)return console.log("Nenhum ID de receita favorito v\xE1lido ap\xF3s a filtragem."),y([]);let I=l.length>10?l.slice(0,10):l,t=g(this.recipesCollection,R("__name__","in",I));return h(A(t)).pipe(v(s=>b(this,null,function*(){let p=[],a=[];for(let m of s.docs){let d=m.data(),U="Desconhecido";if(d.user_id)try{let N=d.user_id instanceof T?d.user_id:c(this.firestore,"users",d.user_id);a.push(f(N).then(E=>{if(E.exists()){let P=E.data();return P.user_name||P.displayName||P.email||"Desconhecido"}return"Desconhecido"}).catch(E=>(console.error(`Erro ao buscar nome de usu\xE1rio para ID ${d.user_id}:`,E),"Desconhecido")))}catch(N){console.error(`Erro inesperado ao processar user_id ${d.user_id}:`,N),a.push(Promise.resolve("Desconhecido"))}else a.push(Promise.resolve("Desconhecido"));p.push({id:m.id,recipeName:d.recipe_name||"Sem Nome",photoUrl:d.photo_url||d.photo||"assets/placeholder.png",description:d.description||"",categoryId:d.category_id?d.category_id.id:null,difficultyId:d.difficulty_id?d.difficulty_id.id:null,timeId:d.time_id?d.time_id.id:null,userId:d.user_id?d.user_id instanceof T?d.user_id.id:d.user_id:null,categoryLabel:d.category_label||"N\xE3o definida",difficultyLabel:d.difficulty_label||"N\xE3o definida",timeLabel:d.time_label||"N\xE3o definido",userName:"",ingredientFoodTypes:Array.isArray(d.ingredient_food_type)?d.ingredient_food_type:[],createdAt:d.createdAt instanceof L?d.createdAt.toDate().toISOString():null,readTime:this.calculateReadTimeFromTimeId(d.time_id)})}return(yield Promise.all(a)).forEach((m,d)=>{p[d].userName=m}),p})))}return y([])}),_(r=>(console.error("Erro ao buscar receitas favoritas:",r),y([]))))}};w.\u0275fac=function(i){return new(i||w)},w.\u0275prov=B({token:w,factory:w.\u0275fac,providedIn:"root"});let S=w;return S})();export{ie as a};
